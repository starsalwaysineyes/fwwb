# AI语音合成教学软件 - 后端部署指南

本文档详细介绍AI语音合成教学软件后端项目的部署流程，包括开发环境配置、生产环境部署及常见问题解决方案。

## 目录

- [环境要求](#环境要求)
- [开发环境配置](#开发环境配置)
- [生产环境部署](#生产环境部署)
  - [常规服务器部署](#常规服务器部署)
  - [Docker容器部署](#docker容器部署)
  - [Gunicorn与Nginx配置](#gunicorn与nginx配置)
- [CI/CD自动化部署](#cicd自动化部署)
- [常见问题与解决方案](#常见问题与解决方案)

## 环境要求

- Python >= 3.8
- pip (Python包管理器)
- 数据库 (SQLite开发环境/MySQL或PostgreSQL生产环境)
- FFmpeg (用于视频处理)

## 开发环境配置

1. **创建虚拟环境**

   ```bash
   # 创建虚拟环境
   python -m venv venv

   # 激活虚拟环境(Windows)
   venv\Scripts\activate

   # 激活虚拟环境(Linux/Mac)
   source venv/bin/activate
   ```

2. **安装依赖**

   ```bash
   cd backend
   pip install -r requirements.txt
   ```

3. **配置环境变量**

   在项目根目录创建`.env`文件：

   ```
   # Flask配置
   FLASK_APP=run.py
   FLASK_CONFIG=development
   
   # 数据库配置(可选，默认使用SQLite)
   # DATABASE_URL=mysql://user:password@localhost/db_name
   
   # TTS服务配置(如果有外部TTS服务)
   # TTS_SERVICE_URL=http://localhost:8000
   
   # 应用密钥(生产环境应更改)
   SECRET_KEY=ai_voice_teaching_app_secret_key
   ```

4. **启动开发服务器**

   ```bash
   python run.py
   ```

   或者

   ```bash
   flask run --host=0.0.0.0
   ```

   访问 http://localhost:5000 查看API服务运行状态

## 生产环境部署

### 常规服务器部署

1. **准备服务器环境**

   确保服务器上安装了Python 3.8+，pip和所需的系统依赖：

   ```bash
   # Ubuntu/Debian系统
   sudo apt update
   sudo apt install python3 python3-pip python3-venv ffmpeg libpq-dev
   
   # CentOS/RHEL系统
   sudo yum install python3 python3-pip ffmpeg
   ```

2. **部署应用代码**

   ```bash
   # 克隆代码或通过SFTP/SCP上传
   git clone <repository-url>
   cd <project-directory>
   
   # 创建并激活虚拟环境
   python3 -m venv venv
   source venv/bin/activate
   
   # 安装依赖
   cd backend
   pip install -r requirements.txt
   ```

3. **配置生产环境变量**

   创建`.env`文件或设置系统环境变量：

   ```
   FLASK_APP=run.py
   FLASK_CONFIG=production
   DATABASE_URL=<生产数据库URL>
   SECRET_KEY=<安全的随机密钥>
   ```

4. **使用Gunicorn运行应用**

   ```bash
   pip install gunicorn
   gunicorn -w 4 -b 0.0.0.0:5000 "backend:create_app('production')"
   ```

### Docker容器部署

1. **创建Dockerfile**

   在项目根目录创建`Dockerfile`：

   ```dockerfile
   FROM python:3.9-slim

   WORKDIR /app

   # 安装系统依赖
   RUN apt-get update && apt-get install -y --no-install-recommends \
       ffmpeg \
       && rm -rf /var/lib/apt/lists/*

   # 复制项目文件
   COPY backend /app/backend
   COPY utils /app/utils
   COPY requirements.txt /app/

   # 安装Python依赖
   RUN pip install --no-cache-dir -r requirements.txt

   # 设置环境变量
   ENV FLASK_APP=run.py
   ENV FLASK_CONFIG=production

   # 暴露端口
   EXPOSE 5000

   # 启动命令
   CMD ["gunicorn", "-w", "4", "-b", "0.0.0.0:5000", "backend:create_app('production')"]
   ```

2. **创建docker-compose.yml**

   ```yaml
   version: '3'

   services:
     backend:
       build: .
       ports:
         - "5000:5000"
       volumes:
         - ./backend/static:/app/backend/static
       environment:
         - FLASK_CONFIG=production
         - SECRET_KEY=your_secret_key
       restart: always
   ```

3. **构建和运行容器**

   ```bash
   docker-compose up -d
   ```

### Gunicorn与Nginx配置

1. **配置Gunicorn服务**

   创建systemd服务文件`/etc/systemd/system/ai-voice-backend.service`：

   ```ini
   [Unit]
   Description=AI Voice Teaching App Backend
   After=network.target

   [Service]
   User=<your-user>
   WorkingDirectory=/path/to/project/backend
   Environment="PATH=/path/to/project/venv/bin"
   Environment="FLASK_CONFIG=production"
   ExecStart=/path/to/project/venv/bin/gunicorn -w 4 -b 127.0.0.1:5000 "backend:create_app('production')"
   Restart=always

   [Install]
   WantedBy=multi-user.target
   ```

   启动服务：

   ```bash
   sudo systemctl start ai-voice-backend
   sudo systemctl enable ai-voice-backend
   ```

2. **Nginx配置**

   创建Nginx配置文件`/etc/nginx/sites-available/ai-voice-backend`：

   ```nginx
   server {
       listen 80;
       server_name api.yourdomain.com;

       location / {
           proxy_pass http://127.0.0.1:5000;
           proxy_set_header Host $host;
           proxy_set_header X-Real-IP $remote_addr;
           proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
       }

       location /static {
           alias /path/to/project/backend/static;
           expires 30d;
       }
   }
   ```

   启用站点并重启Nginx：

   ```bash
   sudo ln -s /etc/nginx/sites-available/ai-voice-backend /etc/nginx/sites-enabled/
   sudo nginx -t
   sudo systemctl restart nginx
   ```

## CI/CD自动化部署

可以使用GitHub Actions或GitLab CI/CD实现自动部署流程：

1. **GitHub Actions示例** (创建`.github/workflows/deploy.yml`):

   ```yaml
   name: Deploy Backend

   on:
     push:
       branches: [ main ]

   jobs:
     deploy:
       runs-on: ubuntu-latest
       steps:
         - uses: actions/checkout@v2
         
         - name: Set up Python
           uses: actions/setup-python@v2
           with:
             python-version: '3.9'
             
         - name: Install dependencies
           run: |
             python -m pip install --upgrade pip
             pip install -r backend/requirements.txt
             
         - name: Run tests
           run: |
             cd backend
             pytest
             
         - name: Deploy to server
           uses: appleboy/ssh-action@master
           with:
             host: ${{ secrets.SERVER_HOST }}
             username: ${{ secrets.SERVER_USER }}
             key: ${{ secrets.SERVER_SSH_KEY }}
             script: |
               cd /path/to/project
               git pull
               source venv/bin/activate
               cd backend
               pip install -r requirements.txt
               sudo systemctl restart ai-voice-backend
   ```

## 常见问题与解决方案

### 数据库连接问题

**问题**: 应用无法连接到数据库。

**解决方案**:
- 检查数据库连接字符串是否正确
- 确保数据库服务在运行
- 检查防火墙配置是否允许数据库连接

### 文件上传权限问题

**问题**: 文件上传失败，出现权限错误。

**解决方案**:
- 确保`backend/static/uploads`目录存在且有正确的写入权限
- 调整运行应用的用户权限：`sudo chown -R <user>:<group> backend/static`

### 依赖安装失败

**问题**: 安装特定依赖包时出错。

**解决方案**:
- 安装依赖的系统库：`sudo apt install python3-dev libpq-dev`
- 尝试单独安装有问题的包，查看具体错误信息

### TTS服务连接问题

**问题**: 无法连接到TTS服务。

**解决方案**:
- 检查TTS服务是否在运行
- 确认TTS服务URL配置是否正确
- 检查网络连接和防火墙设置 